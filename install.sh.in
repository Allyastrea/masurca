#!/bin/sh

set -xe

ROOT=`pwd`
[ -z "$DEST" ] && DEST="$ROOT"

###################
# Check for gmake #
###################
mkdir -p dist-bin
PATH=$PATH:$ROOT/dist-bin
ln -sf $(which make) $ROOT/dist-bin/gmake
ln -sf $ROOT/PkgConfig.pm $ROOT/dist-bin/pkg-config

export NUM_THREADS=`grep -c '^processor' /proc/cpuinfo 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 1`;
BINDIR=$DEST/bin
LIBDIR=$DEST/lib
export PKG_CONFIG_PATH=$LIBDIR/pkgconfig:$PKG_CONFIG_PATH
(cd global-1 && ./configure --prefix=$DEST --bindir=$BINDIR --libdir=$LIBDIR && make -j $NUM_THREADS install)

(cd CA/src && make LD_RUN_PATH="$LIBDIR")
# (cd CA8/kmer && make install)
# (cd CA8/samtools && make)
# (cd CA8/src && make)

if [ "$ROOT" != "$DEST" ]; then
    for i in CA CA8; do
        if [ -d ${i}/Linux-amd64/bin ]; then
            mkdir -p $DEST/${i}/Linux-amd64/bin
            cp -R ${i}/Linux-amd64/bin/* $DEST/${i}/Linux-amd64/bin
        fi
    done
fi

abs2rel () { perl -MFile::Spec -e 'print(File::Spec->abs2rel($ARGV[1], $ARGV[0]), "\n")' "$@"; }

if [ -n "$MKREL" ]; then
    chrpath -k -r "\$ORIGIN"/$(abs2rel "$BINDIR" "$LIBDIR") "$BINDIR"/* 2>/dev/null || true
    for i in CA CA8; do
        if [ -d "$DEST"/${i}/Linux-amd64/bin ]; then
            chrpath -k -r "\$ORIGIN"/$(abs2rel "$DEST"/$i/Linux-amd64/bin "$LIBDIR") "$DEST"/$i/Linux-amd64/bin/* 2>/dev/null || true
        fi
    done
fi

echo "creating sr_config_example.txt with correct PATHS"
$BINDIR/masurca -g sr_config_example.txt
