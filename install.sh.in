#!/bin/sh

set -xe

ROOT=`pwd`
[ -z "$DEST" ] && DEST="$ROOT"

###################
# Check for gmake #
###################
mkdir -p dist-bin
PATH=$PATH:$ROOT/dist-bin
ln -s $(which make) $ROOT/dist-bin/gmake
ln -s $ROOT/PkgConfig.pm $ROOT/dist-bin/pkg-config

export JF_DIR=jellyfish
export SR_DIR=SuperReads
export QR_DIR=quorum
export NUM_THREADS=`grep -c '^processor' /proc/cpuinfo 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 1`;

(cd $JF_DIR && ./configure --prefix=$DEST --program-suffix=-2.0 && make -j $NUM_THREADS install)

export PKG_CONFIG_PATH=$(make -s -C $JF_DIR print-pkgconfigdir):$PKG_CONFIG_PATH
BINDIR=$(make -s -C $JF_DIR print-bindir)
LIBDIR=$(make -s -C $JF_DIR print-libdir)
PATH="$BINDIR:$PATH"

(cd CA/kmer && ./configure.sh && make && make install)
(cd CA/src && make LD_RUN_PATH="$LIBDIR")
(cd $SR_DIR && ./configure --prefix=$DEST && make -j $NUM_THREADS install)
(cd $QR_DIR && ./configure --prefix=$DEST --enable-relative-paths && make -j $NUM_THREADS install)

if [ "$ROOT" != "$DEST" ]; then
    mkdir -p $DEST/CA/Linux-amd64/bin
    cp -R CA/Linux-amd64/bin/* $DEST/CA/Linux-amd64/bin
fi

abs2rel () { perl -MFile::Spec -e 'print(File::Spec->abs2rel($ARGV[1], $ARGV[0]), "\n")' "$@"; }

if [ -n "$MKREL" ]; then
    chrpath -r "\$ORIGIN"/$(abs2rel "$BINDIR" "$LIBDIR") "$BINDIR"/*
    chrpath -r "\$ORIGIN"/$(abs2rel "$DEST"/CA/Linux-amd64/bin "$LIBDIR") "$DEST"/CA/Linux-amd64/bin/*
end

echo "creating sr_config_example.txt with correct PATHS"
$BINDIR/masurca -g sr_config_example.txt
